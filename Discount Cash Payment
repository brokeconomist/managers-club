import streamlit as st
import numpy as np
import plotly.graph_objects as go

# --------- Î£Ï„Î±Î¸ÎµÏÎ­Ï‚ Î±Ï€ÏŒ Excel -----------
current_sales = 1000
extra_sales = 250
cost_pct = 0.80
wacc = 0.20
cash_discount_accept_pct = 0.50
cash_discount_days = 10
non_discount_accept_days = 120
cash_discount_accept_days = 60
current_collection_period = 90

# --------- Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ NPV Î±Î½Î¬ Ï€Î¿ÏƒÎ¿ÏƒÏ„ÏŒ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ -----------
def calculate_npv(discount_pct):
    new_avg_collection = (cash_discount_accept_pct * cash_discount_days +
                          (1 - cash_discount_accept_pct) * non_discount_accept_days)
    new_receivables = (current_sales * (1 - discount_pct) * new_avg_collection) / 365
    old_receivables = (current_sales * current_collection_period) / 365
    capital_release = old_receivables - new_receivables
    extra_profit = extra_sales * (1 - cost_pct)
    release_profit = capital_release * wacc
    discount_cost = current_sales * discount_pct * cash_discount_accept_pct
    npv = extra_profit + release_profit - discount_cost
    return npv

# --------- Î¥Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯ Î³Î¹Î± Î³ÏÎ±Ï†Î¹ÎºÏŒ -----------
discount_rates = np.arange(0.0, 0.11, 0.01)
npvs = [calculate_npv(d) for d in discount_rates]

max_npv = max(npvs)
max_index = npvs.index(max_npv)
optimal_discount = discount_rates[max_index]

break_even_discount = None
for i in range(1, len(npvs)):
    if npvs[i-1] > 0 and npvs[i] < 0:
        break_even_discount = discount_rates[i-1] + 0.01
        break

# --------- Streamlit UI -----------
st.subheader("ðŸ“ˆ Î”Î¹Î¬Î³ÏÎ±Î¼Î¼Î± NPV ÏƒÎµ ÏƒÏ‡Î­ÏƒÎ· Î¼Îµ Ï„Î·Î½ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·")

fig = go.Figure()
fig.add_trace(go.Scatter(
    x=discount_rates * 100,
    y=npvs,
    mode='lines+markers',
    name='NPV',
    line=dict(color='royalblue')
))

fig.add_vline(x=optimal_discount * 100, line=dict(color='green', dash='dash'),
              annotation_text=f"Î’Î­Î»Ï„Î¹ÏƒÏ„Î·: {optimal_discount*100:.2f}%", annotation_position="top left")

if break_even_discount:
    fig.add_vline(x=break_even_discount * 100, line=dict(color='red', dash='dash'),
                  annotation_text=f"Break-even: {break_even_discount*100:.2f}%", annotation_position="top right")

fig.update_layout(
    xaxis_title='Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ (%)',
    yaxis_title='ÎšÎ±Î¸Î±ÏÎ® Î Î±ÏÎ¿ÏÏƒÎ± Î‘Î¾Î¯Î± (NPV)',
    title='NPV vs Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ ÎˆÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ Î³Î¹Î± Ï€Î»Î·ÏÏ‰Î¼Î® Ï„Î¿Î¹Ï‚ Î¼ÎµÏ„ÏÎ·Ï„Î¿Î¯Ï‚',
    hovermode='x unified',
    template='simple_white'
)

st.plotly_chart(fig, use_container_width=True)

st.markdown("""
- âœ… Î— **Ï€ÏÎ¬ÏƒÎ¹Î½Î· Î´Î¹Î±ÎºÎµÎºÎ¿Î¼Î¼Î­Î½Î· Î³ÏÎ±Î¼Î¼Î®** Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î· Î²Î­Î»Ï„Î¹ÏƒÏ„Î· Î­ÎºÏ€Ï„Ï‰ÏƒÎ· Ï€Î¿Ï… Î¼ÎµÎ³Î¹ÏƒÏ„Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ NPV.
- âŒ Î— **ÎºÏŒÎºÎºÎ¹Î½Î· Î³ÏÎ±Î¼Î¼Î®** Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î¿ break-even ÏƒÎ·Î¼ÎµÎ¯Î¿ (ÏŒÏ€Î¿Ï… Ï„Î¿ NPV = 0).
- ðŸ“‰ Î Î­ÏÎ± Î±Ï€ÏŒ Ï„Î¿ Î²Î­Î»Ï„Î¹ÏƒÏ„Î¿ ÏƒÎ·Î¼ÎµÎ¯Î¿, Ï„Î¿ ÎºÏŒÏƒÏ„Î¿Ï‚ Ï„Î·Ï‚ Î­ÎºÏ€Ï„Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡Î¯Î¶ÎµÎ¹ Î½Î± Ï…Ï€ÎµÏÎºÎ±Î»ÏÏ€Ï„ÎµÎ¹ Ï„Î± Î¿Ï†Î­Î»Î·.
""")
